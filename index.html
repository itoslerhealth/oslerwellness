<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Osler Wellness — POS & Stock</title>
  <meta http-equiv="Content-Security-Policy"
        content="frame-ancestors https://clinic.platomedical.com https://*.platomedical.com;">
  <link rel="icon" href="/osler-wellness.webp">
  <style>
    :root {
      --bg: #0f172a; --panel:#0b1220; --muted:#9aa4b2; --text:#e5e7eb; --brand:#14b8a6; --accent:#1e293b;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    .chip{display:inline-block;background:#111827;color:#cbd5e1;border:1px solid #1f2937;border-radius:999px;padding:4px 10px;font:12px/1.2 monospace;margin-left:8px}
    .tabs{display:flex;gap:8px;margin:16px 0}
    .tab{padding:8px 12px;background:#0b1220;border:1px solid #1f2937;border-radius:999px;cursor:pointer}
    .tab.active{background:#0f766e;border-color:#0f766e}
    .panel{background:var(--panel);border:1px solid #1f2937;border-radius:12px;padding:16px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input,select{width:100%;padding:10px;border-radius:10px;border:1px solid #1f2937;background:#0b1220;color:#e5e7eb}
    button{border:0;border-radius:10px;padding:10px 14px;background:var(--brand);color:#052e2b;cursor:pointer}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border-bottom:1px solid #1f2937;text-align:left;padding:10px}
    .row{display:flex;gap:8px;align-items:end;flex-wrap:wrap}
    .btn-muted{background:#1f2937;color:#cbd5e1}
    .pill{padding:2px 8px;border-radius:999px;background:#1f2937;color:#cbd5e1;font-size:12px}
    .danger{background:#7f1d1d;color:#fee2e2}
    .right{float:right}
    .note{font-size:12px;color:#9aa4b2}
    .ok{color:#34d399}
    .err{color:#fca5a5}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<div class="wrap">
  <h2>Osler Wellness — POS & Stock
    <span id="sbState" class="chip">Supabase: ...</span>
    <span id="locState" class="chip">Locations: SV & RH1</span>
  </h2>

  <div class="tabs">
    <div class="tab active" data-tab="pos">Dispense (POS)</div>
    <div class="tab" data-tab="inv">Inventory & Transfer</div>
    <div class="tab" data-tab="admin">Product Admin</div>
  </div>

  <div class="panel" id="tab-pos">
    <div class="grid">
      <div class="col" style="grid-column: span 5;">
        <label>Product</label>
        <select id="posProduct"></select>
      </div>
      <div class="col" style="grid-column: span 2;">
        <label>Location</label>
        <select id="posLoc">
          <option value="SV">SV</option>
          <option value="RH1">RH1</option>
        </select>
      </div>
      <div class="col" style="grid-column: span 2;">
        <label>Quantity</label>
        <input id="posQty" type="number" value="1" min="1" />
      </div>
      <div class="col" style="grid-column: span 3;">
        <label>Unit Price</label>
        <input id="posPrice" type="number" value="0" step="0.01" />
      </div>

      <div class="col" style="grid-column: span 4;">
        <label>Doctor Initials</label>
        <input id="posDoctor" placeholder="e.g., AB" />
      </div>
      <div class="col" style="grid-column: span 5;">
        <label>Dosage / Remarks</label>
        <input id="posRemarks" placeholder="e.g., 1 tab per day" />
      </div>
      <div class="col" style="grid-column: span 3;">
        <label>Patient ID (Plato)</label>
        <input id="posPatientId" placeholder="auto if opened from patient page" />
      </div>

      <div class="col row" style="grid-column: 1 / -1; justify-content:flex-start;">
        <button id="addToCart">+ Add to Cart</button>
        <span class="note">Cart supports multiple items before submit.</span>
      </div>
    </div>

    <h3>Cart</h3>
    <table id="cartTable">
      <thead>
        <tr><th>Product</th><th>Loc</th><th>Qty</th><th>Unit</th><th>Line</th><th>Actions</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="row" style="justify-content:space-between;margin-top:12px;">
      <div class="note">Items: <span id="cartCount">0</span> · Total: $<span id="cartTotal">0.00</span></div>
      <button id="submitCart" class="right">✓ Submit</button>
    </div>

    <h3 style="margin-top:24px;">Recent Movements</h3>
    <table id="txTable">
      <thead><tr><th>Date/Time</th><th>Type</th><th>Product</th><th>From</th><th>To</th><th>Qty</th><th>Actions</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="panel" id="tab-inv" style="display:none">
    <h3>Quick Stock — Receive into RH1</h3>
    <div class="grid">
      <div class="col" style="grid-column: span 6;">
        <label>Product</label>
        <select id="recvProduct"></select>
      </div>
      <div class="col" style="grid-column: span 3;">
        <label>Location</label>
        <select id="recvLoc">
          <option value="RH1">RH1</option>
          <option value="SV">SV</option>
        </select>
      </div>
      <div class="col" style="grid-column: span 3;">
        <label>Receive Qty</label>
        <input id="recvQty" type="number" value="1" min="1" />
      </div>
      <div class="col" style="grid-column: 1 / -1;">
        <button id="recvBtn">Receive to RH1</button>
      </div>
    </div>

    <h3 style="margin-top:20px;">Transfer between locations</h3>
    <div class="grid">
      <div class="col" style="grid-column: span 6;">
        <label>Product</label>
        <select id="xferProduct"></select>
      </div>
      <div class="col" style="grid-column: span 2;">
        <label>From</label>
        <select id="xferFrom">
          <option value="RH1">RH1</option>
          <option value="SV">SV</option>
        </select>
      </div>
      <div class="col" style="grid-column: span 2;">
        <label>To</label>
        <select id="xferTo">
          <option value="SV">SV</option>
          <option value="RH1">RH1</option>
        </select>
      </div>
      <div class="col" style="grid-column: span 2;">
        <label>Quantity</label>
        <input id="xferQty" type="number" value="1" min="1" />
      </div>
      <div class="col" style="grid-column: 1 / -1;">
        <button id="xferBtn">Transfer</button>
      </div>
    </div>

    <h3 style="margin-top:20px;">Inventory</h3>
    <table id="invTable">
      <thead><tr><th>Product</th><th>Barcode</th><th>Price</th><th>On Hand (SV)</th><th>On Hand (RH1)</th><th>Actions</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="panel" id="tab-admin" style="display:none">
    <div class="grid">
      <div class="col" style="grid-column: span 6;">
        <label>Product Name</label>
        <input id="adminName" placeholder="e.g., Amoxicillin 500mg" />
      </div>
      <div class="col" style="grid-column: span 3;">
        <label>Barcode</label>
        <input id="adminBarcode" placeholder="EAN/UPC or custom" />
      </div>
      <div class="col" style="grid-column: span 3;">
        <label>Selling Price</label>
        <input id="adminPrice" type="number" step="0.01" value="0" />
      </div>
      <div class="col" style="grid-column: span 12;">
        <button id="saveProduct">Save Product</button>
      </div>
    </div>
    <p class="note">Use the edit buttons in the Inventory table to modify existing products.</p>
  </div>
</div>

<script>
const SUPABASE_URL = "https://zwocjuiqkmfgtenzjdcy.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp3b2NqdWlxa21mZ3RlbnpqZGN5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5Njk4MDEsImV4cCI6MjA3MjU0NTgwMX0.c4OyvfF3tfFM6uwaEcbUMh6WJJqythetshxThrMuAQg";

const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const tabs = [...document.querySelectorAll('.tab')];
const panels = {
  pos: document.getElementById('tab-pos'),
  inv: document.getElementById('tab-inv'),
  admin: document.getElementById('tab-admin'),
};

tabs.forEach(t => t.addEventListener('click', () => {
  tabs.forEach(x => x.classList.remove('active'));
  t.classList.add('active');
  const k = t.dataset.tab;
  for (const [key, el] of Object.entries(panels)) {
    el.style.display = (key === k) ? '' : 'none';
  }
}));

const fmt = n => (Number(n||0)).toFixed(2);
let PRODUCTS = [];
let CART = [];

const posProduct = document.getElementById('posProduct');
const posLoc = document.getElementById('posLoc');
const posQty = document.getElementById('posQty');
const posPrice = document.getElementById('posPrice');
const posDoctor = document.getElementById('posDoctor');
const posRemarks = document.getElementById('posRemarks');
const posPatientId = document.getElementById('posPatientId');

const recvProduct = document.getElementById('recvProduct');
const recvLoc = document.getElementById('recvLoc');
const recvQty = document.getElementById('recvQty');

const xferProduct = document.getElementById('xferProduct');
const xferFrom = document.getElementById('xferFrom');
const xferTo = document.getElementById('xferTo');
const xferQty = document.getElementById('xferQty');

const cartTable = document.querySelector('#cartTable tbody');
const cartCount = document.getElementById('cartCount');
const cartTotal = document.getElementById('cartTotal');
const txTable = document.querySelector('#txTable tbody');
const invTable = document.querySelector('#invTable tbody');
const sbState = document.getElementById('sbState');

async function pingSupabase() {
  try {
    const { data, error } = await sb.from('products').select('id').limit(1);
    if (error) throw error;
    sbState.textContent = 'Supabase: OK';
    sbState.classList.add('ok');
  } catch (e) {
    sbState.textContent = 'Supabase: ERROR';
    sbState.classList.add('err');
  }
}

function fillSelect(sel, arr) {
  sel.innerHTML = '';
  arr.forEach(p => {
    const opt = document.createElement('option');
    opt.value = p.id;
    opt.textContent = p.name;
    sel.appendChild(opt);
  });
}

async function loadProducts() {
  const { data, error } = await sb
    .from('products_with_balances')
    .select('*')
    .order('name', { ascending: true });
  if (error) { console.error(error); return; }
  PRODUCTS = data || [];
  fillSelect(posProduct, PRODUCTS);
  fillSelect(recvProduct, PRODUCTS);
  fillSelect(xferProduct, PRODUCTS);
  renderInventory();
}

function renderInventory() {
  invTable.innerHTML = '';
  PRODUCTS.forEach(p => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${p.name}</td>
      <td>${p.barcode || ''}</td>
      <td>$${fmt(p.sell_price || p.price || 0)}</td>
      <td>${p.on_hand_sv || 0}</td>
      <td>${p.on_hand_rh1 || 0}</td>
      <td><button class="btn-muted" data-edit="${p.id}">Edit</button></td>`;
    invTable.appendChild(tr);
  });
  invTable.querySelectorAll('[data-edit]').forEach(btn => {
    btn.addEventListener('click', () => openEdit(btn.getAttribute('data-edit')));
  });
}

function openEdit(id) {
  const p = PRODUCTS.find(x => x.id === id);
  if (!p) return;
  document.querySelector('.tab.active').classList.remove('active');
  document.querySelector('.tab[data-tab="admin"]').classList.add('active');
  panels.pos.style.display='none'; panels.inv.style.display='none'; panels.admin.style.display='';
  document.getElementById('adminName').value = p.name || '';
  document.getElementById('adminBarcode').value = p.barcode || '';
  document.getElementById('adminPrice').value = p.sell_price || p.price || 0;
  document.getElementById('saveProduct').dataset.editId = p.id;
}

function renderCart() {
  cartTable.innerHTML = '';
  let total = 0;
  CART.forEach((it, idx) => {
    const line = it.qty * it.price;
    total += line;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${it.product_name}</td>
      <td>${it.loc}</td>
      <td>${it.qty}</td>
      <td>$${fmt(it.price)}</td>
      <td>$${fmt(line)}</td>
      <td><button class="danger" data-rm="${idx}">Remove</button></td>`;
    cartTable.appendChild(tr);
  });
  cartTable.querySelectorAll('[data-rm]').forEach(btn => {
    btn.addEventListener('click', () => {
      CART.splice(Number(btn.getAttribute('data-rm')),1);
      renderCart();
    });
  });
  cartCount.textContent = CART.length;
  cartTotal.textContent = fmt(total);
}

document.getElementById('addToCart').addEventListener('click', () => {
  const id = posProduct.value;
  const p = PRODUCTS.find(x => x.id === id);
  if (!p) return alert('Pick a product');
  const qty = Number(posQty.value || 0);
  if (qty <= 0) return alert('Qty must be > 0');
  const price = Number(posPrice.value || 0);
  CART.push({ product_id:id, product_name:p.name, loc:posLoc.value, qty, price, doctor:posDoctor.value||'', remarks:posRemarks.value||'' });
  renderCart();
});

document.getElementById('submitCart').addEventListener('click', async () => {
  if (!CART.length) return;
  const patient = posPatientId.value || null;
  for (const it of CART) {
    const { error } = await sb.rpc('post_sale_at', {
      p_product: it.product_id, p_loc: it.loc, p_qty: it.qty, p_price: it.price,
      p_patient: patient, p_doctor: it.doctor, p_remarks: it.remarks
    });
    if (error) { alert('Error: ' + error.message); return; }
  }
  CART.length = 0; renderCart();
  await loadProducts(); await loadTx();
});

document.getElementById('recvBtn').addEventListener('click', async () => {
  const id = recvProduct.value; const qty = Number(recvQty.value || 0); const loc = recvLoc.value || 'RH1';
  if (!id || qty <= 0) return alert('Pick product & qty > 0');
  const { error } = await sb.rpc('receive_stock', { p_product: id, p_loc: loc, p_qty: qty });
  if (error) return alert('Error: ' + error.message);
  await loadProducts(); await loadTx();
});

document.getElementById('xferBtn').addEventListener('click', async () => {
  const id = xferProduct.value; const qty = Number(xferQty.value || 0);
  const f = xferFrom.value, t = xferTo.value;
  if (!id || qty <= 0) return alert('Pick product & qty > 0');
  if (f === t) return alert('From and To cannot be the same');
  const { error } = await sb.rpc('transfer_stock', { p_product: id, p_from: f, p_to: t, p_qty: qty });
  if (error) return alert('Error: ' + error.message);
  await loadProducts(); await loadTx();
});

document.getElementById('saveProduct').addEventListener('click', async (e) => {
  const name = document.getElementById('adminName').value.trim();
  const barcode = document.getElementById('adminBarcode').value.trim() || null;
  const price = Number(document.getElementById('adminPrice').value || 0);
  if (!name) return alert('Name required');
  const editId = e.target.dataset.editId;
  if (editId) {
    const { error } = await sb.from('products').update({ name, barcode, sell_price: price }).eq('id', editId);
    if (error) return alert('Update error: ' + error.message);
    e.target.dataset.editId = "";
  } else {
    const { error } = await sb.from('products').insert({ name, barcode, sell_price: price });
    if (error) return alert('Insert error: ' + error.message);
  }
  document.getElementById('adminName').value = '';
  document.getElementById('adminBarcode').value = '';
  document.getElementById('adminPrice').value = '0';
  await loadProducts();
});

async function loadTx() {
  const { data, error } = await sb
    .from('transactions')
    .select('id, created_at, type, product_name, from_loc, to_loc, qty_in, qty_out')
    .order('created_at', { ascending: false })
    .limit(20);
  if (error) { console.error(error); return; }
  txTable.innerHTML = '';
  (data||[]).forEach(t => {
    const qty = t.qty_in > 0 ? t.qty_in : t.qty_out;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${new Date(t.created_at).toLocaleString()}</td>
      <td>${t.type}</td>
      <td>${t.product_name||''}</td>
      <td>${t.from_loc||''}</td>
      <td>${t.to_loc||''}</td>
      <td>${qty||0}</td>
      <td>
        <button class="btn-muted" data-upload="${t.id}">Upload</button>
        <button class="danger" data-void="${t.id}">Void</button>
      </td>`;
    txTable.appendChild(tr);
  });
  txTable.querySelectorAll('[data-void]').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = btn.getAttribute('data-void');
      const { error } = await sb.rpc('void_transaction', { p_tx_id: id });
      if (error) return alert('Void error: ' + error.message);
      await loadProducts(); await loadTx();
    });
  });
  txTable.querySelectorAll('[data-upload]').forEach(btn => {
    btn.addEventListener('click', () => uploadTx(btn.getAttribute('data-upload')));
  });
}

async function uploadTx(id) {
  const { data, error } = await sb.from('transactions').select('*').eq('id', id).single();
  if (error) return alert('Load tx error: ' + error.message);
  const patient_id = posPatientId.value || null;
  if (!patient_id) return alert('Please fill Patient ID (Plato) top-right field first.');
  const payload = {
    patient_id,
    doctor_initials: data.doctor_initials || '',
    remarks: data.remarks || '',
    items: [{
      product: data.product_name || 'Item',
      qty: data.qty_in > 0 ? data.qty_in : data.qty_out,
      dosage: data.remarks || ''
    }]
  };
  const resp = await fetch('/.netlify/functions/create_plato_note', {
    method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)
  });
  if (!resp.ok) {
    const txt = await resp.text(); alert('Upload error: ' + txt);
  } else {
    alert('Uploaded to Plato as draft.');
  }
}

const urlPid = new URLSearchParams(location.search).get('patientId');
if (urlPid) document.getElementById('posPatientId').value = urlPid;

(async function init(){ await pingSupabase(); await loadProducts(); await loadTx(); })();
</script>
</body>
</html>