<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Osler Wellness — POS & Stock</title>
  <link rel="icon" href="osler-wellness.webp">
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#10b981; --warn:#f43f5e;
      --pill:#1f2937; --chip:#334155; --btn:#0ea5e9;
    }
    *{box-sizing:border-box}body{margin:0;background:#0b1220;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    header{display:flex;align-items:center;gap:.75rem;padding:16px 20px;border-bottom:1px solid #1e293b;background:linear-gradient(180deg,#0b1220,#0b1220)}
    header img{height:22px;opacity:.9}
    .title{font-weight:700;letter-spacing:.2px}
    .chip{font-size:12px;background:var(--chip);border-radius:999px;padding:4px 10px;display:inline-flex;gap:6px;align-items:center;margin-left:6px}
    .container{max-width:1080px;margin:24px auto;padding:0 16px}
    .tabs{display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap}
    .tab{background:#111827;border:1px solid #1f2937;border-radius:999px;padding:8px 12px;font-weight:600;cursor:pointer}
    .tab.active{background:#0ea5e9;border-color:#22d3ee}
    .card{background:#0f172a;border:1px solid #1e293b;border-radius:14px;padding:16px;margin:12px 0}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .row+.row{margin-top:10px}
    label{font-size:12px;color:var(--muted)}
    input,select,button,textarea{font:inherit}
    input,select,textarea{width:100%;padding:10px 12px;border-radius:8px;background:#0b1220;border:1px solid #1e293b;color:var(--text)}
    textarea{min-height:44px;resize:vertical}
    .btn{background:#0ea5e9;border:none;border-radius:10px;color:white;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn.green{background:var(--accent)}
    .btn.ghost{background:#111827}
    .btn.red{background:#ef4444}
    .btn.small{padding:6px 10px;font-weight:600;border-radius:8px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #1e293b;text-align:left}
    th{color:#93c5fd;font-weight:700;background:#0b1220;position:sticky;top:0}
    .right{text-align:right}
    .pill{background:#0b1220;border:1px solid #1e293b;border-radius:8px;padding:8px 10px}
    .flex{display:flex;gap:8px;align-items:center}
    .hide{display:none}
    .muted{color:var(--muted)}
    .toast{position:fixed;right:16px;bottom:16px;background:#111827;border:1px solid #1f2937;border-radius:10px;padding:10px 14px;max-width:340px}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center}
    .modal>.card{width:min(520px,90%);max-height:90vh;overflow:auto}
  </style>
</head>
<body>
<header>
  <img src="osler-wellness.webp" alt="logo"/><span class="title">Osler Wellness — POS & Stock</span>
  <span class="chip">Supabase: <b id="sbStatus">…</b></span>
  <span class="chip">Locations: <b>SV & RH1</b></span>
</header>

<div class="container">
  <div class="tabs">
    <button class="tab active" data-tab="pos">Dispense (POS)</button>
    <button class="tab" data-tab="inv">Inventory & Transfer</button>
    <button class="tab" data-tab="admin">Product Admin</button>
  </div>

  <!-- POS TAB -->
  <section id="tab-pos" class="card">
    <h3 style="margin:4px 0 12px">Dispense</h3>
    <div class="row">
      <div class="col" style="grid-column:span 5">
        <label>Product</label>
        <select id="posProduct"></select>
      </div>
      <div class="col" style="grid-column:span 2">
        <label>Location</label>
        <select id="posLoc">
          <option value="SV">SV</option>
          <option value="RH1">RH1</option>
        </select>
      </div>
      <div class="col" style="grid-column:span 2">
        <label>Quantity</label>
        <input id="posQty" type="number" min="1" value="1"/>
      </div>
      <div class="col" style="grid-column:span 3">
        <label>Unit Price</label>
        <input id="posPrice" type="number" step="0.01" min="0" />
      </div>
    </div>
    <div class="row">
      <div class="col" style="grid-column:span 4">
        <label>Doctor Initials</label>
        <input id="posDoctor" placeholder="e.g., AB"/>
      </div>
      <div class="col" style="grid-column:span 5">
        <label>Dosage / Remarks</label>
        <input id="posRemarks" placeholder="e.g., 1 tab bd"/>
      </div>
      <div class="col" style="grid-column:span 3">
        <label>Patient ID (Plato)</label>
        <input id="posPatient" placeholder="auto if opened from patient page"/>
      </div>
    </div>
    <div class="flex" style="margin-top:10px">
      <button class="btn ghost" id="addToCart">+ Add to Cart</button>
    </div>

    <div class="card" style="margin-top:14px">
      <div class="flex" style="justify-content:space-between"><h4>Cart</h4>
        <div class="muted">Items: <b id="cartCount">0</b> · Total: $<b id="cartTotal">0.00</b></div>
      </div>
      <table id="cartTable">
        <thead><tr>
          <th>Product</th><th>Loc</th><th class="right">Qty</th><th class="right">Unit</th><th class="right">Line</th><th>Actions</th>
        </tr></thead>
        <tbody></tbody>
      </table>
      <div class="right" style="margin-top:10px"><button id="submitCart" class="btn green">✔ Submit</button></div>
    </div>

    <div class="card">
      <h4>Recent Movements</h4>
      <table id="txTable">
        <thead><tr>
          <th>Date/Time</th><th>Type</th><th>Product</th><th>From</th><th>To</th><th class="right">Qty</th><th>Actions</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- INVENTORY TAB -->
  <section id="tab-inv" class="card hide">
    <h3>Inventory & Transfer</h3>
    <div class="card">
      <h4>Quick Stock — Receive into RH1</h4>
      <div class="row">
        <div class="col" style="grid-column:span 6">
          <label>Product</label>
          <select id="rxProduct"></select>
        </div>
        <div class="col" style="grid-column:span 2">
          <label>Location</label>
          <input class="pill" value="RH1" disabled/>
        </div>
        <div class="col" style="grid-column:span 2">
          <label>Receive Qty</label>
          <input id="rxQty" type="number" min="1" value="1"/>
        </div>
        <div class="col" style="grid-column:span 2;align-self:end">
          <button id="btnReceive" class="btn green" style="width:100%">Receive to RH1</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h4>Transfer between locations</h4>
      <div class="row">
        <div class="col" style="grid-column:span 6">
          <label>Product</label>
          <select id="xferProduct"></select>
        </div>
        <div class="col" style="grid-column:span 2">
          <label>From</label>
          <select id="xferFrom"><option>RH1</option><option>SV</option></select>
        </div>
        <div class="col" style="grid-column:span 2">
          <label>To</label>
          <select id="xferTo"><option>SV</option><option>RH1</option></select>
        </div>
        <div class="col" style="grid-column:span 1">
          <label>Qty</label>
          <input id="xferQty" type="number" min="1" value="1"/>
        </div>
        <div class="col" style="grid-column:span 1;align-self:end">
          <button id="btnXfer" class="btn" style="width:100%">Transfer</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h4>Inventory</h4>
      <table id="invTable">
        <thead><tr>
          <th>Product</th><th>Barcode</th><th class="right">Price</th><th class="right">On Hand (SV)</th><th class="right">On Hand (RH1)</th><th>Actions</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- ADMIN TAB -->
  <section id="tab-admin" class="card hide">
    <h3>Product Admin</h3>
    <div class="row">
      <div class="col" style="grid-column:span 5">
        <label>Product Name</label>
        <input id="admName" placeholder="e.g., Amoxicillin 500mg"/>
      </div>
      <div class="col" style="grid-column:span 3">
        <label>Barcode</label>
        <input id="admBarcode" placeholder="EAN/UPC or custom"/>
      </div>
      <div class="col" style="grid-column:span 2">
        <label>Selling Price</label>
        <input id="admPrice" type="number" step="0.01" min="0" value="0"/>
      </div>
      <div class="col" style="grid-column:span 2;align-self:end">
        <button id="btnAddProduct" class="btn green" style="width:100%">Save Product</button>
      </div>
    </div>
    <div class="card">
      <h4>Products</h4>
      <table id="admTable">
        <thead><tr>
          <th>Product</th><th>Barcode</th><th class="right">Price</th><th>Actions</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</div>

<div id="editModal" class="modal">
  <div class="card">
    <h3>Edit Product</h3>
    <div class="row" style="margin-top:10px">
      <div class="col" style="grid-column:span 6">
        <label>Name</label>
        <input id="emName"/>
      </div>
      <div class="col" style="grid-column:span 3">
        <label>Barcode</label>
        <input id="emBarcode"/>
      </div>
      <div class="col" style="grid-column:span 3">
        <label>Price</label>
        <input id="emPrice" type="number" step="0.01" min="0"/>
      </div>
    </div>
    <div class="right" style="margin-top:12px">
      <button class="btn ghost small" id="emCancel">Cancel</button>
      <button class="btn green small" id="emSave">Save</button>
    </div>
  </div>
</div>

<div id="toast" class="toast hide"></div>

<script type="module">
  // === CONFIG ===
  const SUPABASE_URL = "https://zwocjuiqkmfgtenzjdcy.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp3b2NqdWlxa21mZ3RlbnpqZGN5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5Njk4MDEsImV4cCI6MjA3MjU0NTgwMX0.c4OyvfF3tfFM6uwaEcbUMh6WJJqythetshxThrMuAQg";
  const PLATO_FN_URL = "/.netlify/functions/plato-create-note";

  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  document.getElementById('sbStatus').textContent = "OK";

  // UI helpers
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const toast = (msg, ok=true) => {
    const t = $("#toast");
    t.textContent = msg;
    t.classList.remove("hide");
    t.style.borderColor = ok ? "#065f46" : "#7f1d1d";
    t.style.background = ok ? "#064e3b" : "#111827";
    setTimeout(()=>t.classList.add("hide"), 3500);
  };

  // Tabs
  $$(".tab").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      $$(".tab").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      const tab = btn.dataset.tab;
      $("#tab-pos").classList.toggle("hide", tab!=="pos");
      $("#tab-inv").classList.toggle("hide", tab!=="inv");
      $("#tab-admin").classList.toggle("hide", tab!=="admin");
    });
  });

  // Detect Plato patient ID if opened inside Plato
  function detectPatientId(){
    try{
      const h = location.href;
      const marker = "/#patients/";
      const idx = h.indexOf(marker);
      if(idx>-1){
        const rest = h.slice(idx+marker.length);
        const pid = rest.split("/")[0];
        if(pid && pid.length>8) return pid;
      }
    }catch(e){}
    return "";
  }
  const autoPid = detectPatientId();
  if(autoPid) $("#posPatient").value = autoPid;

  // Data caches
  let products = [];
  let editProductId = null;

  async function loadProducts(){
    const { data, error } = await sb.from("products_with_balances").select("*").order("name");
    if(error){ toast("Load products failed: "+error.message,false); return; }
    products = data || [];
    // populate selects
    const opts = ['<option value="">— select —</option>'].concat(
      products.map(p=>`<option value="${p.id}" data-price="${p.sell_price||0}">${p.name}</option>`)
    ).join("");
    $("#posProduct").innerHTML = opts;
    $("#rxProduct").innerHTML = opts;
    $("#xferProduct").innerHTML = opts;
    // tables
    renderInventory();
    renderAdminTable();
  }

  function renderInventory(){
    const tb = $("#invTable tbody");
    tb.innerHTML = products.map(p=>`
      <tr>
        <td>${p.name}</td>
        <td>${p.barcode||""}</td>
        <td class="right">${(p.sell_price||0).toFixed(2)}</td>
        <td class="right">${p.on_hand_sv||0}</td>
        <td class="right">${p.on_hand_rh1||0}</td>
        <td><button class="btn small ghost" data-edit="${p.id}">Edit</button></td>
      </tr>
    `).join("");
    tb.querySelectorAll("[data-edit]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const p = products.find(x=>x.id===btn.dataset.edit);
        if(!p) return;
        editProductId = p.id;
        $("#emName").value = p.name||"";
        $("#emBarcode").value = p.barcode||"";
        $("#emPrice").value = p.sell_price||0;
        $("#editModal").style.display="flex";
      });
    });
  }

  $("#emCancel").onclick = ()=>$("#editModal").style.display="none";
  $("#emSave").onclick = async ()=>{
    if(!editProductId) return;
    const upd = {
      name: $("#emName").value.trim(),
      barcode: $("#emBarcode").value.trim()||null,
      sell_price: Number($("#emPrice").value||0)
    };
    const { error } = await sb.from("products").update(upd).eq("id", editProductId);
    if(error){ toast("Update failed: "+error.message,false); return; }
    $("#editModal").style.display="none";
    await loadProducts();
    toast("Product updated");
  };

  // Admin add product
  $("#btnAddProduct").onclick = async ()=>{
    const name = $("#admName").value.trim();
    if(!name) return toast("Name required", false);
    const ins = {
      name,
      barcode: $("#admBarcode").value.trim()||null,
      sell_price: Number($("#admPrice").value||0)
    };
    const { error } = await sb.from("products").insert(ins);
    if(error){ toast("Insert failed: "+error.message,false); return; }
    $("#admName").value = $("#admBarcode").value = ""; $("#admPrice").value = 0;
    await loadProducts();
    toast("Product saved");
  };

  // Quick receive
  $("#btnReceive").onclick = async ()=>{
    const pid = $("#rxProduct").value;
    const qty = Number($("#rxQty").value||0);
    if(!pid || qty<=0) return toast("Pick product & qty",false);
    const { error } = await sb.rpc("receive_stock",{ p_product: pid, p_loc: "RH1", p_qty: qty });
    if(error){ toast("Receive failed: "+error.message,false); return; }
    await loadProducts(); await loadTx();
    toast("Received into RH1");
  };

  // Transfer
  $("#btnXfer").onclick = async ()=>{
    const pid = $("#xferProduct").value;
    const q = Number($("#xferQty").value||0);
    const from = $("#xferFrom").value, to = $("#xferTo").value;
    if(!pid || q<=0) return toast("Pick product & qty",false);
    const { error } = await sb.rpc("transfer_stock",{ p_product: pid, p_from: from, p_to: to, p_qty: q });
    if(error){ toast("Transfer failed: "+error.message,false); return; }
    await loadProducts(); await loadTx();
    toast("Transfer done");
  };

  // POS cart
  const cart = [];
  $("#posProduct").addEventListener("change", e=>{
    const sel = e.target.selectedOptions[0];
    const price = Number(sel?.dataset?.price||0);
    $("#posPrice").value = price.toFixed(2);
  });

  function renderCart(){
    const tb = $("#cartTable tbody");
    let total = 0;
    tb.innerHTML = cart.map((l,idx)=>{
      const line = l.qty*l.price;
      total += line;
      return `<tr>
        <td>${l.product_name}</td>
        <td>${l.loc}</td>
        <td class="right">${l.qty}</td>
        <td class="right">${l.price.toFixed(2)}</td>
        <td class="right">${line.toFixed(2)}</td>
        <td><button class="btn small red" data-del="${idx}">Remove</button></td>
      </tr>`;
    }).join("");
    $("#cartCount").textContent = String(cart.length);
    $("#cartTotal").textContent = total.toFixed(2);
    tb.querySelectorAll("[data-del]").forEach(b=>{
      b.onclick = ()=>{ cart.splice(Number(b.dataset.del),1); renderCart(); };
    });
  }

  $("#addToCart").onclick = ()=>{
    const pid = $("#posProduct").value;
    if(!pid) return toast("Select a product first",false);
    const p = products.find(x=>x.id===pid);
    const qty = Number($("#posQty").value||0);
    const price = Number($("#posPrice").value||0);
    const loc = $("#posLoc").value;
    if(qty<=0) return toast("Qty must be > 0",false);
    cart.push({
      product_id: pid,
      product_name: p?.name||"Item",
      qty, price, loc,
      patient: $("#posPatient").value.trim()||null,
      doctor: $("#posDoctor").value.trim()||null,
      remarks: $("#posRemarks").value.trim()||null
    });
    renderCart();
  };

  $("#submitCart").onclick = async ()=>{
    if(cart.length===0) return;
    for(const l of cart){
      const { error } = await sb.rpc("post_sale_at",{
        p_product: l.product_id, p_loc: l.loc, p_qty: l.qty,
        p_price: l.price, p_patient: l.patient, p_doctor: l.doctor, p_remarks: l.remarks
      });
      if(error){ toast("Sale failed: "+error.message,false); return; }
    }
    cart.length = 0; renderCart();
    await loadProducts(); await loadTx();
    toast("Sale(s) posted");
  };

  // Recent movements
  async function loadTx(){
    const { data, error } = await sb.from("transactions").select("*").order("created_at",{ascending:false}).limit(30);
    if(error){ toast("Load tx failed: "+error.message,false); return; }
    const tb = $("#txTable tbody");
    tb.innerHTML = (data||[]).map(t=>{
      const qty = t.qty_in && t.qty_in>0 ? t.qty_in : (t.qty_out||0);
      const disabled = t.voided ? "disabled" : "";
      return `<tr>
        <td>${new Date(t.created_at).toLocaleString()}</td>
        <td>${t.type}${t.voided?" (void)":""}</td>
        <td>${t.product_name||""}</td>
        <td>${t.from_loc||""}</td>
        <td>${t.to_loc||""}</td>
        <td class="right">${qty}</td>
        <td class="flex">
          <button class="btn small ghost" data-upload="${t.id}">Upload</button>
          <button class="btn small red" ${disabled} data-void="${t.id}">Void</button>
        </td>
      </tr>`;
    }).join("");

    tb.querySelectorAll("[data-void]").forEach(b=>{
      b.onclick = async ()=>{
        const { error } = await sb.rpc("void_transaction",{ p_tx_id: b.dataset.void });
        if(error){ toast("Void failed: "+error.message,false); return; }
        await loadProducts(); await loadTx();
        toast("Transaction voided");
      };
    });

    tb.querySelectorAll("[data-upload]").forEach(b=>{
      b.onclick = ()=>doUpload(b.dataset.upload);
    });
  }

  async function doUpload(txId){
    // Fetch the tx record
    const { data, error } = await sb.from("transactions").select("*").eq("id", txId).single();
    if(error){ return toast("Cannot load transaction: "+error.message,false); }
    const patientId = $("#posPatient").value.trim() || data.patient_id || autoPid;
    if(!patientId){ return toast("No Patient ID. Enter one in the POS form first.",false); }

    const title = "Osler Wellness – Supplement Order";
    const html = `
      <h3>Supplement Order</h3>
      <ul>
        <li><b>Product:</b> ${data.product_name||""}</li>
        <li><b>Qty:</b> ${data.qty_out||data.qty_in||0}</li>
        <li><b>Dosage/Remarks:</b> ${data.remarks||""}</li>
        <li><b>Ordering Doctor:</b> ${data.doctor_initials||""}</li>
        <li><b>Location:</b> ${data.from_loc||data.to_loc||""}</li>
        <li><b>Date:</b> ${new Date(data.created_at).toLocaleString()}</li>
      </ul>
    `;

    try{
      const res = await fetch(PLATO_FN_URL,{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ patientId, title, html })
      });
      const body = await res.json();
      if(!res.ok){ throw new Error(body?.message || "Upload failed"); }
      toast("Uploaded to Plato as draft note");
    }catch(e){
      toast("Upload error: "+e.message,false);
    }
  }

  // Init
  await loadProducts();
  await loadTx();
</script>
</body>
</html>
