<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Osler Wellness — POS</title>
  <style>
    :root{--bg:#0b1220;--card:#121a2a;--text:#e5eefb;--muted:#9bb0d3;--pill:#1e293b;--accent:#16a34a;--danger:#dc2626}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    .row{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px}
    .h1{font-size:20px;font-weight:700}
    .pill{display:inline-block;background:var(--pill);color:var(--muted);border-radius:999px;padding:4px 10px;font-size:12px;margin-left:8px}
    .card{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 2px 14px rgba(0,0,0,.25);margin-bottom:16px}
    label{display:block;font-size:12px;color:var(--muted);margin:6px 0}
    input,select{width:100%;box-sizing:border-box;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:#0e1525;color:var(--text)}
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .btn{border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn.primary{background:var(--accent);color:#05150a}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,.2);color:var(--text)}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.06)}
    th{color:var(--muted);font-weight:600;text-align:left}
  </style>
  <script defer src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="row">
      <div class="h1">Osler Wellness — POS
        <span id="supabaseStatus" class="pill">Supabase: …</span>
      </div>
      <div>
        <button id="btnBack" class="btn ghost">← Back to patient tab</button>
      </div>
    </div>

    <div class="card">
      <div style="font-weight:700;margin-bottom:8px;">Dispense (POS)</div>
      <div class="grid">
        <div><label>Product</label><select id="product"></select></div>
        <div><label>Location</label>
          <select id="loc"><option>RH1</option><option>SV</option></select>
        </div>
        <div><label>Qty</label><input id="qty" type="number" value="1" min="1" /></div>
        <div><label>Unit Price</label><input id="price" type="number" value="0" min="0" step="0.01" /></div>
        <div><label>Doctor</label><input id="doctor" placeholder="AB" /></div>
        <div><label>Dosage / Remarks</label><input id="remarks" placeholder="1 tab bd" /></div>
        <div><label>Patient ID</label><input id="patient" placeholder="auto if opened from patient tab" /></div>
        <div style="display:flex;align-items:flex-end;"><button id="add" class="btn primary" style="width:100%;">+ Add</button></div>
      </div>

      <table id="cart">
        <thead><tr><th>Product</th><th>Loc</th><th>Qty</th><th>Unit</th><th>Line</th><th>Actions</th></tr></thead>
        <tbody id="cartBody"><tr><td colspan="6" style="color:#9bb0d3">No items.</td></tr></tbody>
      </table>
      <div style="text-align:right;margin-top:10px;">
        <button id="submit" class="btn primary">✔ Submit</button>
      </div>
    </div>

    <div class="card">
      <div style="font-weight:700;margin-bottom:8px;">Recent Movements</div>
      <table>
        <thead><tr><th>Date/Time</th><th>Type</th><th>Product</th><th>From</th><th>To</th><th>Qty</th><th>Actions</th></tr></thead>
        <tbody id="moves"></tbody>
      </table>
    </div>
  </div>

<script>
(function(){
  const params = new URLSearchParams(location.search);
  const patientIdFromUrl = params.get('patient_id') || '';

  const SUPABASE_URL  = localStorage.getItem('SUPABASE_URL') || '';
  const SUPABASE_KEY  = localStorage.getItem('SUPABASE_ANON_KEY') || '';

  const supabaseStatus = document.getElementById('supabaseStatus');
  if(!SUPABASE_URL || !SUPABASE_KEY){
    supabaseStatus.textContent = 'Supabase: missing';
    supabaseStatus.style.background = '#3f1d2b';
  } else {
    supabaseStatus.textContent = 'Supabase: OK';
  }

  const client = (SUPABASE_URL && SUPABASE_KEY) ? supabase.createClient(SUPABASE_URL, SUPABASE_KEY) : null;

  const cart = [];
  const cartBody = document.getElementById('cartBody');
  const patientInput = document.getElementById('patient');
  if (patientIdFromUrl) patientInput.value = patientIdFromUrl;

  function fmt(n){ return Number(n||0).toFixed(2); }

  function renderCart(){
    cartBody.innerHTML = '';
    if(cart.length===0){
      cartBody.innerHTML = '<tr><td colspan="6" style="color:#9bb0d3">No items.</td></tr>';
      return;
    }
    cart.forEach((it, idx) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${it.product_name}</td>
        <td>${it.loc}</td>
        <td>${it.qty}</td>
        <td>${fmt(it.price)}</td>
        <td>${fmt(it.qty*it.price)}</td>
        <td><button data-i="${idx}" class="btn ghost">Remove</button></td>`;
      tr.querySelector('button').onclick = (e)=>{
        const i = Number(e.target.getAttribute('data-i'));
        cart.splice(i,1); renderCart();
      };
      cartBody.appendChild(tr);
    });
  }

  // Load products
  async function loadProducts(){
    const sel = document.getElementById('product');
    sel.innerHTML = '<option value="">Loading…</option>';
    if(!client){ sel.innerHTML = '<option value="">Supabase not configured</option>'; return; }
    const { data, error } = await client.from('products_with_balances').select('*').order('name');
    if(error){ sel.innerHTML = '<option value="">Error loading</option>'; console.error(error); return; }
    sel.innerHTML = '<option value="">— select —</option>' + data.map(p=>`<option value="${p.id}" data-price="${p.sell_price}" data-name="${p.name}">${p.name}</option>`).join('');
    sel.onchange = (e)=>{
      const opt = sel.selectedOptions[0];
      if(opt){ document.getElementById('price').value = opt.getAttribute('data-price') || 0; }
    };
  }

  // Add to cart
  document.getElementById('add').onclick = ()=>{
    const sel = document.getElementById('product');
    const opt = sel.selectedOptions[0];
    const id = sel.value;
    if(!id){ alert('Select a product'); return; }
    const loc = document.getElementById('loc').value;
    const qty = Math.max(1, Number(document.getElementById('qty').value||1));
    const price = Number(document.getElementById('price').value||0);
    const doctor = document.getElementById('doctor').value||'';
    const remarks = document.getElementById('remarks').value||'';
    const patient = (document.getElementById('patient').value||'').trim();

    cart.push({ product_id:id, product_name: opt.getAttribute('data-name'), loc, qty, price, doctor, remarks, patient });
    renderCart();
  };

  // Submit (batch sales)
  document.getElementById('submit').onclick = async ()=>{
    if(!client){ return alert('Supabase missing'); }
    if(cart.length===0){ return alert('Cart empty'); }
    try{
      for(const it of cart){
        const { error } = await client.rpc('post_sale_at', {
          p_product: it.product_id,
          p_loc: it.loc,
          p_qty: it.qty,
          p_price: it.price,
          p_patient: it.patient || null,
          p_doctor: it.doctor || null,
          p_remarks: it.remarks || null
        });
        if(error) throw error;
      }
      cart.length = 0; renderCart();
      await loadMovements();
      alert('Submitted.');
    }catch(e){ console.error(e); alert('Error: '+e.message); }
  };

  // Movements
  async function loadMovements(){
    const tb = document.getElementById('moves');
    if(!client){ tb.innerHTML = ''; return; }
    const { data, error } = await client.from('transactions_view').select('*').limit(20);
    if(error){ tb.innerHTML = '<tr><td colspan="7" style="color:#9bb0d3">Error loading</td></tr>'; return; }
    tb.innerHTML = '';
    for(const r of data){
      const tr = document.createElement('tr');
      const d = new Date(r.ts);
      tr.innerHTML = `<td>${d.toLocaleString()}</td>
        <td>${r.type}</td>
        <td>${r.product_name}</td>
        <td>${r.from_loc||''}</td>
        <td>${r.to_loc||''}</td>
        <td>${r.qty}</td>
        <td>
          <button class="btn ghost" data-id="${r.id}" data-action="upload">Upload</button>
          <button class="btn ghost" data-id="${r.id}" data-action="void">Void</button>
        </td>`;
      tr.querySelectorAll('button').forEach(btn=>btn.onclick = async (ev)=>{
        const id = Number(ev.target.getAttribute('data-id'));
        const action = ev.target.getAttribute('data-action');
        if(action==='void'){
          const { error } = await client.rpc('void_tx', { p_tx_id:id });
          if(error){ alert('Void failed: '+error.message); } else { await loadMovements(); }
        }else if(action==='upload'){
          // Build a tiny payload for Plato draft note
          const rec = data.find(x=>x.id===id);
          const payload = {
            product: rec.product_name,
            qty: rec.qty,
            doctor: rec.doctor || '',
            remarks: rec.remarks || '',
            patient_id: rec.patient_id || patientInput.value || patientIdFromUrl || ''
          };
          const res = await fetch('/.netlify/functions/create-patient-note', {
            method:'POST',
            headers:{'content-type':'application/json'},
            body: JSON.stringify(payload)
          });
          const txt = await res.text();
          alert('Upload result: ' + txt);
        }
      });
      tb.appendChild(tr);
    }
  }

  document.getElementById('btnBack').onclick = ()=>{
    if (patientIdFromUrl) {
      window.location.href = '/patient.html?patient_id=' + encodeURIComponent(patientIdFromUrl);
    } else {
      window.close();
    }
  };

  loadProducts();
  loadMovements();
})();
</script>
</body>
</html>
