<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Osler Wellness — Patient</title>
  <style>
    :root{--bg:#0b1220;--card:#121a2a;--text:#e5eefb;--muted:#9bb0d3;--pill:#1e293b;--accent:#16a34a;--danger:#dc2626}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    .row{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px}
    .h1{font-size:20px;font-weight:700}
    .pill{display:inline-block;background:var(--pill);color:var(--muted);border-radius:999px;padding:4px 10px;font-size:12px;margin-left:8px}
    .card{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 2px 14px rgba(0,0,0,.25)}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.06)}
    th{color:var(--muted);font-weight:600;text-align:left}
    .btn{border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn.outline{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.2)}
    .btn.primary{background:var(--accent);color:#05150a}
    .empty{color:var(--muted);padding:22px 8px}
    .note{color:var(--muted);font-size:12px;margin-top:10px}
    a{color:#93c5fd}
  </style>
  <script defer src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="row">
      <div class="h1">Osler Wellness — POS & Stock
        <span id="supabaseStatus" class="pill">Supabase: …</span>
      </div>
      <div>
        <button id="btnDispense" class="btn primary">Dispense ↗</button>
      </div>
    </div>

    <div class="card">
      <div class="h1" style="font-size:16px;margin-bottom:8px;">Osler Wellness — Patient Dispenses</div>
      <table id="tbl">
        <thead><tr><th>Date</th><th>Product</th><th>Qty</th><th>Doctor</th><th>Dosage/Remarks</th></tr></thead>
        <tbody id="tbody"><tr><td colspan="5" class="empty">Loading…</td></tr></tbody>
      </table>
      <div class="note" id="contextNote"></div>
    </div>
  </div>

<script>
(function(){
  const params = new URLSearchParams(location.search);
  const patientId = params.get('patient_id') || '';   // Plato will append this if configured
  const token = params.get('token') || '';            // Plato app token (optional today)

  const SUPABASE_URL  = localStorage.getItem('SUPABASE_URL') || '';
  const SUPABASE_KEY  = localStorage.getItem('SUPABASE_ANON_KEY') || '';

  // Status pill
  const supabaseStatus = document.getElementById('supabaseStatus');
  if(!SUPABASE_URL || !SUPABASE_KEY){
    supabaseStatus.textContent = 'Supabase: missing';
    supabaseStatus.style.background = '#3f1d2b';
  } else {
    supabaseStatus.textContent = 'Supabase: OK';
  }

  // Open full POS in new tab, forwarding context if we have it
  document.getElementById('btnDispense').onclick = () => {
    const q = new URLSearchParams();
    if (patientId) q.set('patient_id', patientId);
    if (token) q.set('token', token);
    window.open('/index.html' + (q.toString()?('?'+q.toString()):''), '_blank', 'noopener');
  };

  // Render helper
  function render(rows){
    const tb = document.getElementById('tbody');
    tb.innerHTML = '';
    if(!rows || rows.length===0){
      tb.innerHTML = '<tr><td colspan="5" class="empty">No dispenses yet for this patient.</td></tr>';
      return;
    }
    for(const r of rows){
      const tr = document.createElement('tr');
      const d = new Date(r.ts);
      tr.innerHTML = `<td>${d.toLocaleString()}</td>
        <td>${r.product_name||''}</td>
        <td>${r.qty||0}</td>
        <td>${r.doctor||''}</td>
        <td>${r.remarks||''}</td>`;
      tb.appendChild(tr);
    }
  }

  // Context note for debugging
  const ctx = document.getElementById('contextNote');
  if(!patientId){
    ctx.innerHTML = "No <b>patient_id</b> in URL. The tab will still load, but the table will be empty. If this is inside Plato, edit the app manifest URL to: <code>https://YOUR-SITE.netlify.app/patient.html</code> (Plato will append <code>?patient_id=…&token=…</code> automatically when opened from a patient).";
  } else {
    ctx.textContent = 'Patient: ' + patientId;
  }

  // Fetch data if we can
  if (!SUPABASE_URL || !SUPABASE_KEY || !patientId) {
    render([]);
    return;
  }
  const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  client
    .from('patient_dispenses')
    .select('*')
    .eq('patient_id', patientId)
    .order('ts', { ascending: false })
    .limit(200)
    .then(({data, error}) => {
      if (error) {
        console.error(error);
        document.getElementById('tbody').innerHTML = '<tr><td colspan="5" class="empty">Error loading: '+error.message+'</td></tr>';
      } else {
        render(data);
      }
    });
})();
</script>
</body>
</html>
